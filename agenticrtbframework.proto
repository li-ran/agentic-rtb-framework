syntax = "proto2";

package com.iabtechlab.bidstream.mutation.v1;

// Import OpenRTB definitions
import "com/iabtechlab/openrtb/v2.6/openrtb.proto";


// ------------------- Services -------------------

service RTBExtensionPoint {
  // GetMutations returns RTBResponse containing mutations to be applied at the predetermined auction lifecycle event
  rpc GetMutations (RTBRequest) returns (RTBResponse);
}

// ------------------- Messages -------------------

message RTBRequest {
  // ENUM as per Programmatic Auction Definition IAB TL doc/spec
  required Lifecycle lifecycle = 1;

  // ID of the extension point request, assigned by the exchange, and unique for the
  // exchange's subsequent tracking of the responses. The exchange may use
  // different values for different recipients.
  // REQUIRED by the RTB specification.
  required string id = 2;

  // Maximum time in milliseconds the exchange allows for mutations to be received including latency to avoid timeout
  // REQUIRED by the RTB specification.
  required int32 tmax = 3;

  // Bid request
  // REQUIRED by the RTB specification.
  required com.iabtechlab.openrtb.v2_6.BidRequest bid_request = 4;

  // Bid response
  // OPTIONAL by the RTB specification.
  optional com.iabtechlab.openrtb.v2_6.BidResponse bid_response = 5;

  // Extension fields
  optional Extensions ext = 6;
}

enum Lifecycle {
  // Placeholder to Define Programmatic Auction Definition Stages
  LIFECYCLE_UNSPECIFIED = 0;
  
  // More to be added
}

message Extensions {
  // Placeholder for future fields
  extensions 100 to max;
}

message RTBResponse {
  // ID of the extension point request to which this is a response.
  // REQUIRED by the RTB specification.
  required string id = 1;

  // List of mutations suggesting changes to be applied
  repeated Mutation mutations = 2;

  // Metadata about the response
  optional Metadata metadata = 3;
}

message Mutation {
  // The purpose of the mutation
  required Intent intent = 1;

  // Defines the operation to perform (e.g. add, remove, replace) on the target data at the given path
  required Operation op = 2;

  // The semantic business domain of where the operation will be applied
  required string path = 3;

  // The structure of value depends on the specified intent.
  // Reserve 100+ for intent-specific payloads
  oneof value {
    // List of string Identifiers
    IDsPayload ids = 100;

    // Adjust properties of a specific deal
    AdjustDealPayload adjust_deal = 101;

    // Adjust the bid price
    AdjustBidPayload adjust_bid = 102;

    // Add metrics or telemetry data
    AddMetricsPayload add_metrics = 103;
  }
}

enum Operation {
  OPERATION_UNSPECIFIED = 0;
  OPERATION_ADD = 1;
  OPERATION_REMOVE = 2;
  OPERATION_REPLACE = 3;

  // More operations can be added in the future
}

enum Intent {
  INTENT_UNSPECIFIED = 0;

  // Activate user segments by their external segment IDs
  ACTIVATE_SEGMENTS = 1;

  // Activate deals by their external deal IDs
  ACTIVATE_DEALS = 2;

  // Suppress deals by their external deal IDs
  SUPPRESS_DEALS = 3;

  // Adjust the bid floor of a specific deal
  ADJUST_DEAL_FLOOR = 4;

  // Adjust the deal margin of a specific deal
  ADJUST_DEAL_MARGIN = 5;

  // Adjust the bid price of a specific bid
  BID_SHADE = 6;

  // Add metrics to an impression
  ADD_METRICS = 7;

  // More intents can be added in the future
}

message Metadata {
  // Version of the data provider API
  optional string api_version = 1;

  // The model version utilized by the container or API to compute the mutation if applicable
  optional string model_version = 2;

  // More metadata fields can be added in the future
}

message IDsPayload {
  // List of IDs. Context of the ID is determined by the intent
  repeated string id = 1;
}

message AdjustDealPayload {
  //  Suggested bid floor for the deal
  optional double bidfloor = 1;

  // Suggested margin for the deal
  optional Margin margin = 2;
}

message Margin {
  // The adjusted margin value
  optional double value = 1;

  // The type of margin adjustment
  enum CalculationType {
    // Absolute margin adjustment
    CPM = 0;

    // Relative margin adjustment (percentage)
    PERCENT = 1;
  }

  optional CalculationType calculation_type = 2;
}

message AdjustBidPayload {
  // The adjusted bid price
  optional double price = 1;
}

message AddMetricsPayload {
  // List of metrics to add
  repeated com.iabtechlab.openrtb.v2_6.BidRequest.Imp.Metric metric = 1;
}
